-- Ensure schema exists
CREATE SCHEMA IF NOT EXISTS app;

-- Saga State table
CREATE TABLE IF NOT EXISTS app.order_state
(
    correlation_id    uuid PRIMARY KEY,
    current_state     varchar(64),
    customer_email    varchar(256),
    total             numeric(18,2) NOT NULL DEFAULT 0,
    stock_ok          boolean NOT NULL DEFAULT false,
    payment_ok        boolean NOT NULL DEFAULT false,
    payment_auth_code varchar(64),
    created_at_utc    timestamptz NOT NULL DEFAULT now(),
    completed_at_utc  timestamptz
);

-- MassTransit Outbox Message table
CREATE TABLE IF NOT EXISTS app.outbox_message
(
    sequence_number   bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    enqueue_time_utc  timestamptz,
    sent_time_utc     timestamptz NOT NULL,
    headers           text,
    properties        text,
    message_id        uuid NOT NULL,
    conversation_id   uuid,
    correlation_id    uuid,
    initiator_id      uuid,
    request_id        uuid,
    source_address    text,
    destination_address text,
    response_address  text,
    fault_address     text,
    message_type      text NOT NULL,
    payload           bytea NOT NULL,
    expiration_time   timestamptz,
    persist_until     timestamptz
);

-- MassTransit Outbox State table
CREATE TABLE IF NOT EXISTS app.outbox_state
(
    outbox_id        uuid PRIMARY KEY,
    created          timestamptz NOT NULL,
    delivered        timestamptz,
    lock_id          uuid,
    row_version      bigint NOT NULL
);

-- MassTransit Inbox State table
CREATE TABLE IF NOT EXISTS app.inbox_state
(
    inbox_id         uuid PRIMARY KEY,
    message_id       uuid NOT NULL,
    consumer_id      uuid NOT NULL,
    lock_id          uuid,
    row_version      bigint NOT NULL,
    received         timestamptz NOT NULL,
    delivered        timestamptz
);

-- Indexes to match MassTransit EF defaults
CREATE INDEX IF NOT EXISTS idx_outbox_message_enqueue_time_utc ON app.outbox_message (enqueue_time_utc);
CREATE INDEX IF NOT EXISTS idx_outbox_message_sent_time_utc    ON app.outbox_message (sent_time_utc);
CREATE INDEX IF NOT EXISTS idx_order_state_current_state       ON app.order_state (current_state);


SELECT * FROM app.inbox_state
SELECT * FROM app.outbox_state
SELECT * FROM app.outbox_message
SELECT * FROM app.order_state

TRUNCATE TABLE 
    app.inbox_state,
    app.outbox_state,
    app.outbox_message,
    app.order_state
RESTART IDENTITY CASCADE;